#!/usr/bin/env bash
#
# https://github.com/getmicah/spotify-now

# get track info
album () {
    res=$(echo "$MSG" | grep -m 1 "xesam:album" -b1 | tail -n1)
    res="${res%\"*}"
    res="${res#*\"}"
    echo "$res"
}
artist () {
    res=$(echo "$MSG" | grep -m 1 "xesam:albumArtist" -b2 | tail -n1)
    res="${res%\"*}"
    res="${res#*\"}"
    echo "$res"
}
disc () {
    res=$(echo "$MSG" | grep -m 1 "xesam:discNumber" -b1 | tail -n1)
    res="${res#*3}"
    res="${res#*2}"
    echo "$res"
}
title () {
    res=$(echo "$MSG" | grep -m 1 "xesam:title" -b1 | tail -n1)
    res="${res%\"*}"
    res="${res#*\"}"
    echo "$res"
}
track () {
    res=$(echo "$MSG" | grep -m 1 "xesam:trackNumber" -b1 | tail -n1)
    res="${res#*3}"
    res="${res#*2}"
    echo "$res"
}

# check if no args
if [[ "$#" -eq 0 ]]; then
    echo "Hello, this is spotify-now"
    echo "Help: 'spotify-now -h'"
    echo "Info: https://github.com/getmicah/spotify-now"
    exit 0
elif [[ "${1}" == "-h" ]]; then
    echo -e "\nUsage: spotify-now -i \"<info>\" -e \"<error>\""
    echo -e "\n\"<info>\" can contain the following keywords:"
    echo -e "\t%album, %artist, %disc, %title, %track"
    echo -e "\n\"<error>\" your custom Spotify closed message."
    echo -e "\nhttps://github.com/getmicah/spotify-now\n"
    exit 0
elif [[ "$#" != 4 ]]; then
    echo "Error: invalid arguments"
    echo "Help: 'spotify-now -h'"
    exit 0
elif [[ "${1}" != "-i" ]]; then
    echo "Error: invalid arguments"
    echo "Help: 'spotify-now -h'"
    exit 0
elif [[ "${3}" != "-e" ]]; then
    echo "Error: invalid arguments"
    echo "Help: 'spotify-now -h'"
    exit 0
fi

# check if spotify is running
status=`pidof spotify | wc -l`
if [[ $status != 1 ]]; then
    echo "${4}"
    exit 0
else
    # get mpris2 dbus status of spotify player
    MSG=`dbus-send --print-reply --session --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:'org.mpris.MediaPlayer2.Player' string:'Metadata'`
    INFO="${2}"
    INFO="${INFO/"%album"/$(album)}"
    INFO="${INFO/"%artist"/$(artist)}"
    INFO="${INFO/"%disc"/$(disc)}"
    INFO="${INFO/"%title"/$(title)}"
    INFO="${INFO/"%track"/$(track)}"
    echo $INFO
fi
